// ملف JavaScript لواجهة الأدمن
document.addEventListener('DOMContentLoaded', function() {
    // تحديث البيانات عند التحميل
    updateAdminData();
    
    // إعداد زر التحديث
    document.getElementById('refreshBtn').addEventListener('click', updateAdminData);
    
    // إعداد زر مسح سجل النظام
    document.getElementById('clearSystemLogBtn').addEventListener('click', clearSystemLog);
    
    // تحديث البيانات كل 10 ثواني
    setInterval(updateAdminData, 10000);
});

// تحديث بيانات الأدمن
async function updateAdminData() {
    try {
        const response = await fetch('/api/admin/get_users');
        const data = await response.json();
        
        if (data.success) {
            updateUsersTable(data.users);
            updateStats(data.users);
        } else {
            showToast('فشل في تحميل بيانات المستخدمين', 'error');
        }
    } catch (error) {
        console.error('Error updating admin data:', error);
        showToast('حدث خطأ في الاتصال بالخادم', 'error');
    }
}

// تحديث جدول المستخدمين
function updateUsersTable(users) {
    const tableBody = document.getElementById('usersTableBody');
    tableBody.innerHTML = '';
    
    if (Object.keys(users).length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted">
                    <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                    لا توجد مستخدمين حالياً
                </td>
            </tr>
        `;
        return;
    }
    
    for (const [userId, userData] of Object.entries(users)) {
        const row = document.createElement('tr');
        row.setAttribute('data-user-id', userId);
        
        // تحديد حالة المستخدم
        let statusBadge = '';
        if (userData.is_running) {
            statusBadge = '<span class="badge bg-success"><i class="fas fa-play me-1"></i>نشط</span>';
        } else if (userData.connected) {
            statusBadge = '<span class="badge bg-warning"><i class="fas fa-pause me-1"></i>متصل</span>';
        } else {
            statusBadge = '<span class="badge bg-secondary"><i class="fas fa-stop me-1"></i>غير متصل</span>';
        }
        
        // تحديد نوع الإرسال
        let sendType = 'يدوي';
        if (userData.settings.send_type === 'scheduled') {
            sendType = 'مجدول';
        } else if (userData.settings.send_type === 'keyword_monitoring') {
            sendType = 'مراقبة الكلمات';
        }
        
        // عدد المجموعات
        const groupsCount = userData.settings.groups ? userData.settings.groups.length : 0;
        
        // أزرار الإجراءات
        let actionButtons = '';
        if (userData.is_running) {
            actionButtons = `
                <button class="btn btn-sm btn-danger stop-user-btn" data-user-id="${userId}">
                    <i class="fas fa-stop me-1"></i>إيقاف
                </button>
            `;
        } else {
            actionButtons = `
                <button class="btn btn-sm btn-secondary" disabled>
                    <i class="fas fa-pause me-1"></i>متوقف
                </button>
            `;
        }
        
        actionButtons += `
            <button class="btn btn-sm btn-info view-details-btn" 
                    data-user-id="${userId}"
                    data-bs-toggle="modal" 
                    data-bs-target="#userDetailsModal">
                <i class="fas fa-eye me-1"></i>عرض
            </button>
        `;
        
        row.innerHTML = `
            <td><code>${userId.substring(0, 8)}...</code></td>
            <td><span class="text-muted">${userData.settings.phone || 'غير محدد'}</span></td>
            <td>${statusBadge}</td>
            <td>
                <small>
                    <span class="text-success">${userData.stats.sent} مرسل</span> /
                    <span class="text-danger">${userData.stats.errors} خطأ</span>
                </small>
            </td>
            <td><span class="badge bg-info">${sendType}</span></td>
            <td><span class="badge bg-primary">${groupsCount} مجموعة</span></td>
            <td>${actionButtons}</td>
        `;
        
        tableBody.appendChild(row);
    }
    
    // إضافة معالجات الأحداث لأزرار الإيقاف
    document.querySelectorAll('.stop-user-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const userId = this.getAttribute('data-user-id');
            stopUser(userId);
        });
    });
    
    // إضافة معالجات الأحداث لأزرار العرض
    document.querySelectorAll('.view-details-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const userId = this.getAttribute('data-user-id');
            showUserDetails(userId);
        });
    });
}

// تحديث الإحصائيات
function updateStats(users) {
    // إجمالي المستخدمين
    document.getElementById('totalUsers').textContent = Object.keys(users).length;
    
    // المستخدمين النشطين
    const activeUsers = Object.values(users).filter(user => user.is_running).length;
    document.getElementById('activeUsers').textContent = activeUsers;
    
    // إجمالي المرسل
    const totalSent = Object.values(users).reduce((sum, user) => sum + user.stats.sent, 0);
    document.getElementById('totalSent').textContent = totalSent;
    
    // إجمالي الأخطاء
    const totalErrors = Object.values(users).reduce((sum, user) => sum + user.stats.errors, 0);
    document.getElementById('totalErrors').textContent = totalErrors;
}

// إيقاف مستخدم
async function stopUser(userId) {
    try {
        const response = await fetch(`/api/admin/stop_user/${userId}`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast(data.message, 'success');
            updateAdminData(); // تحديث البيانات
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        console.error('Error stopping user:', error);
        showToast('حدث خطأ في إيقاف المستخدم', 'error');
    }
}

// عرض تفاصيل المستخدم
async function showUserDetails(userId) {
    try {
        const response = await fetch('/api/admin/get_users');
        const data = await response.json();
        
        if (data.success && data.users[userId]) {
            const userData = data.users[userId];
            const modalContent = document.getElementById('userDetailsContent');
            
            modalContent.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>معلومات المستخدم</h6>
                        <p><strong>ID:</strong> <code>${userId}</code></p>
                        <p><strong>رقم الهاتف:</strong> ${userData.settings.phone || 'غير محدد'}</p>
                        <p><strong>الحالة:</strong> ${userData.is_running ? 'نشط' : 'متوقف'}</p>
                        <p><strong>متصل:</strong> ${userData.connected ? 'نعم' : 'لا'}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>الإحصائيات</h6>
                        <p><strong>تم الإرسال:</strong> ${userData.stats.sent}</p>
                        <p><strong>الأخطاء:</strong> ${userData.stats.errors}</p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>الإعدادات</h6>
                        <pre>${JSON.stringify(userData.settings, null, 2)}</pre>
                    </div>
                </div>
            `;
        } else {
            showToast('فشل في تحميل تفاصيل المستخدم', 'error');
        }
    } catch (error) {
        console.error('Error loading user details:', error);
        showToast('حدث خطأ في تحميل تفاصيل المستخدم', 'error');
    }
}

// مسح سجل النظام
async function clearSystemLog() {
    const logContainer = document.getElementById('systemLogContainer');
    logContainer.innerHTML = '<div class="text-muted">سجل النظام جاهز...</div>';
    showToast('تم مسح سجل النظام', 'success');
}

// عرض إشعار
function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    const toastBody = document.getElementById('toastBody');
    
    // تحديد لون التوست بناءً على النوع
    if (type === 'error') {
        toast.classList.remove('bg-primary', 'bg-success');
        toast.classList.add('bg-danger');
    } else if (type === 'success') {
        toast.classList.remove('bg-primary', 'bg-danger');
        toast.classList.add('bg-success');
    } else {
        toast.classList.remove('bg-success', 'bg-danger');
        toast.classList.add('bg-primary');
    }
    
    toastBody.textContent = message;
    
    // عرض التوست
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
}
